services:
  app:
    container_name: ${CONTAINER_NAME:-balungpisah-citizen-app}
    # image: ${IMAGE_REGISTRY:-ghcr.io/balungpisah/balungpisah-citizen-app}:${IMAGE_TAG:-latest}
    build:
      context: .
      dockerfile: Dockerfile
    env_file:
      - .env
    restart: unless-stopped

    ports:
      - '127.0.0.1:${PORT:-3000}:${PORT:-3000}'

    environment:
      - PORT=${PORT:-3000}
      - HOSTNAME=0.0.0.0

    read_only: true

    cap_drop:
      - ALL

    security_opt:
      - no-new-privileges:true

    tmpfs:
      - /tmp:noexec,nosuid,nodev,size=100m
      - /app/.next/cache:noexec,nosuid,nodev,size=200m

    healthcheck:
      test:
        [
          'CMD',
          'sh',
          '-c',
          'node -e "require(''http'').get(''http://localhost:'' + (process.env.PORT || 3000) + ''/'', (r) => { process.exit(r.statusCode === 200 ? 0 : 1); }).on(''error'', () => process.exit(1));"',
        ]
      interval: 30s
      timeout: 10s
      start_period: 40s
      retries: 3
